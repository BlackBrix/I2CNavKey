/*
 * File:   PWM.c
 * Author: Saimon
 *
 * Created on March 16, 2019, 3:22 PM
 */

//#include	<math.h>
#include "i2c_register.h"
#include "mcc_generated_files/mcc.h"
#include "PWM.h"
#include "main.h"
#include "GPports.h"
#include "DataVariable.h"


const uint16_t gamma_table[7][100] = {
    { 1013, 1003, 992, 982, 972, 962, 951, 941, 931, 921, 910, 900, 890, 880, 870, 859, 849, 839, 829, 818, 808, 798, 788, 777, 767, 757, 747, 737, 726, 716, 706, 696, 685, 675, 665, 655, 644, 634, 624, 614, 604, 593, 583, 573, 563, 552, 542, 532, 522, 511, 501, 491, 481, 471, 460, 450, 440, 430, 419, 409, 399, 389, 379, 368, 358, 348, 338, 327, 317, 307, 297, 286, 276, 266, 256, 246, 235, 225, 215, 205, 194, 184, 174, 164, 153, 143, 133, 123, 113, 102, 92, 82, 72, 61, 51, 41, 31, 20, 10, 0}, //Linear
    { 1023, 1022, 1021, 1020, 1018, 1017, 1014, 1012, 1010, 1007, 1004, 1000, 997, 993, 989, 985, 981, 976, 972, 967, 961, 956, 950, 945, 939, 932, 926, 920, 913, 906, 899, 891, 884, 876, 868, 860, 852, 844, 835, 826, 817, 808, 799, 790, 780, 770, 760, 750, 740, 729, 719, 708, 697, 686, 674, 663, 651, 639, 627, 615, 603, 590, 578, 565, 552, 539, 525, 512, 498, 485, 471, 457, 442, 428, 413, 399, 384, 369, 354, 338, 323, 307, 291, 276, 259, 243, 227, 210, 194, 177, 160, 143, 125, 108, 90, 72, 55, 37, 18, 0}, //GAMMA 1.8
    { 1023, 1023, 1022, 1021, 1020, 1019, 1018, 1016, 1015, 1013, 1011, 1008, 1006, 1003, 1000, 997, 993, 990, 986, 982, 978, 973, 969, 964, 959, 954, 948, 943, 937, 931, 925, 918, 912, 905, 898, 890, 883, 875, 867, 859, 851, 843, 834, 825, 816, 807, 797, 787, 777, 767, 757, 746, 736, 725, 714, 702, 691, 679, 667, 655, 642, 630, 617, 604, 591, 577, 564, 550, 536, 522, 507, 493, 478, 463, 448, 432, 416, 401, 385, 368, 352, 335, 318, 301, 284, 266, 249, 231, 213, 194, 176, 157, 138, 119, 100, 80, 60, 41, 20, 0}, //GAMMA 2.0
    { 1023, 1023, 1023, 1022, 1022, 1021, 1020, 1019, 1018, 1017, 1015, 1013, 1012, 1009, 1007, 1005, 1002, 999, 997, 993, 990, 986, 983, 979, 975, 970, 966, 961, 956, 951, 945, 940, 934, 928, 921, 915, 908, 901, 894, 887, 879, 871, 863, 855, 846, 838, 829, 819, 810, 800, 790, 780, 770, 759, 748, 737, 726, 714, 703, 690, 678, 666, 653, 640, 626, 613, 599, 585, 571, 556, 541, 526, 511, 496, 480, 464, 447, 431, 414, 397, 380, 362, 344, 326, 308, 289, 270, 251, 231, 212, 192, 171, 151, 130, 109, 88, 66, 44, 22, 0}, //GAMMA 2.2
    { 1023, 1023, 1023, 1023, 1022, 1022, 1021, 1021, 1020, 1019, 1018, 1017, 1015, 1014, 1012, 1010, 1008, 1006, 1004, 1002, 999, 996, 993, 990, 986, 983, 979, 975, 971, 966, 961, 957, 951, 946, 941, 935, 929, 923, 916, 910, 903, 895, 888, 880, 872, 864, 856, 847, 838, 829, 820, 810, 800, 790, 779, 769, 758, 746, 735, 723, 711, 698, 685, 672, 659, 646, 632, 618, 603, 588, 573, 558, 542, 526, 510, 494, 477, 459, 442, 424, 406, 388, 369, 350, 330, 311, 291, 270, 250, 229, 207, 186, 164, 141, 118, 95, 72, 48, 24, 0}, //GAMMA 2.4
    { 1023, 1023, 1023, 1023, 1023, 1022, 1022, 1022, 1021, 1020, 1020, 1019, 1018, 1017, 1016, 1014, 1013, 1011, 1009, 1007, 1005, 1003, 1001, 998, 995, 992, 989, 986, 982, 978, 974, 970, 966, 961, 956, 951, 946, 940, 935, 929, 922, 916, 909, 902, 895, 887, 879, 871, 863, 854, 845, 836, 827, 817, 807, 796, 786, 775, 764, 752, 740, 728, 715, 702, 689, 676, 662, 648, 633, 618, 603, 588, 572, 555, 539, 522, 504, 487, 469, 450, 432, 412, 393, 373, 353, 332, 311, 289, 267, 245, 222, 199, 176, 152, 128, 103, 78, 52, 26, 0}, //GAMMA 2.6
    { 1023, 1023, 1023, 1023, 1023, 1023, 1022, 1022, 1022, 1021, 1021, 1020, 1020, 1019, 1018, 1017, 1016, 1015, 1013, 1012, 1010, 1008, 1006, 1004, 1002, 999, 997, 994, 991, 988, 984, 981, 977, 973, 969, 964, 960, 955, 950, 944, 939, 933, 927, 920, 914, 907, 899, 892, 884, 876, 868, 859, 850, 841, 831, 821, 811, 800, 790, 778, 767, 755, 742, 730, 717, 703, 690, 676, 661, 646, 631, 615, 599, 583, 566, 549, 531, 513, 494, 475, 456, 436, 416, 395, 374, 352, 330, 308, 285, 261, 237, 213, 188, 163, 137, 110, 84, 56, 28, 0}, //GAMMA 2.8
};

/*
 * @brief Update the PWM value of the GP1
 */
void PWM_GP1(uint8_t duty) {

    if (duty == 0) {

        GP1_SetHigh();
        UNLOCK_PPS;
        RC2PPSbits.RC2PPS = 0x00;
        LOCK_PPS;
        CCP1CON = 0;
        return;
    }

    if (duty > 100)
        duty = 100;

    if (CCP1CON == 0) {
        UNLOCK_PPS;
        RC2PPSbits.RC2PPS = 0x0C; //RC2->CCP1:PWM1;  
        LOCK_PPS;
        CCP1CON = 0x8F;
    }

    CCPR1H = gamma_table[GAMMAGP1][(uint8_t) (duty - 1)] >> 8;
    CCPR1L = gamma_table[GAMMAGP1][(uint8_t) (duty - 1)];


}

/*
 * @brief Update the PWM value of the GP2
 */
void PWM_GP2(uint8_t duty) {

    if (duty == 0) {

        GP2_SetHigh();
        UNLOCK_PPS;
        RC1PPSbits.RC1PPS = 0x00;
        LOCK_PPS;
        CCP2CON = 0;
        return;
    }

    if (duty > 100)
        duty = 100;

    if (CCP2CON == 0) {
        UNLOCK_PPS;
        RC1PPSbits.RC1PPS = 0x0D; //RC1->CCP2:PWM2;
        LOCK_PPS;
        CCP2CON = 0x8F;
    }

    CCPR2H = gamma_table[GAMMAGP2][(uint8_t) (duty - 1)] >> 8;
    CCPR2L = gamma_table[GAMMAGP2][(uint8_t) (duty - 1)];
}

/*
 * @brief Update the PWM value of the GP3
 */
void PWM_GP3(uint8_t duty) {

    if (duty == 0) {

        GP3_SetHigh();
        UNLOCK_PPS;
        RC0PPSbits.RC0PPS = 0x00;
        LOCK_PPS;
        CCP3CON = 0;
        return;
    }

    if (duty > 100)
        duty = 100;

    if (CCP2CON == 0) {
        UNLOCK_PPS;
        RC0PPSbits.RC0PPS = 0x0E; //RC0->CCP3:PWM3;  
        LOCK_PPS;
        CCP3CON = 0x8F;
    }

    CCPR3H = gamma_table[GAMMAGP3][(uint8_t) (duty - 1)] >> 8;
    CCPR3L = gamma_table[GAMMAGP3][(uint8_t) (duty - 1)];
}

